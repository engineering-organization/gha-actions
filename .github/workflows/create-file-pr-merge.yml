# gha-actions/.github/workflows/create-file-pr-merge.yml
name: Reusable â€” create file, open PR, and merge (GitHub App)

on:
  workflow_call:
    inputs:
      filename:
        required: true
        type: string
      file_content:
        required: true
        type: string
      base_branch:
        required: false
        type: string
        default: main
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true

jobs:
  create-file-pr-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub App installation token
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository using App token
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.token }}
          persist-credentials: true

      - name: Configure git identity
        run: |
          git config user.name "org-level-automation-app[bot]"
          git config user.email "41898282+org-level-automation-app[bot]@users.noreply.github.com"

      - name: Create branch, file, commit and push
        id: push_branch
        env:
          FILENAME: ${{ inputs.filename }}
          CONTENT: ${{ inputs.file_content }}
        run: |
          set -euo pipefail
          BRANCH="gh-app-auto-${GITHUB_RUN_ID}"
          git fetch origin ${{ inputs.base_branch }}:refs/remotes/origin/${{ inputs.base_branch }} || true
          git checkout -b "$BRANCH" "origin/${{ inputs.base_branch }}" || git checkout -b "$BRANCH"

          mkdir -p "$(dirname "$FILENAME")" || true
          printf "%s\n" "$CONTENT" > "$FILENAME"

          git add "$FILENAME"
          git commit -m "chore: add $FILENAME via GitHub App"
          git push --set-upstream origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create pull request
        id: create_pr
        env:
          TOKEN: ${{ steps.app_token.outputs.token }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ steps.push_branch.outputs.branch }}
          BASE: ${{ inputs.base_branch }}
        run: |
          set -euo pipefail
          API="https://api.github.com"
          PAYLOAD=$(jq -n \
            --arg title "chore: add $FILENAME (automated PR)" \
            --arg head "$BRANCH" \
            --arg base "$BASE" \
            --arg body "Automated PR created by org-level-automation-app to add $FILENAME" \
            '{ title: $title, head: $head, base: $base, body: $body }')

          resp=$(curl -sSL -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API/repos/$REPO/pulls" \
            -d "$PAYLOAD")

          pr_number=$(echo "$resp" | jq -r .number)
          pr_url=$(echo "$resp" | jq -r .html_url)
          if [ "$pr_number" = "null" ] || [ -z "$pr_number" ]; then
            echo "Failed creating PR: $resp"
            exit 1
          fi
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo "Created PR #$pr_number: $pr_url"

      - name: Merge pull request
        env:
          TOKEN: ${{ steps.app_token.outputs.token }}
          REPO: ${{ github.repository }}
          PR: ${{ steps.create_pr.outputs.pr_number }}
        run: |
          set -euo pipefail
          API="https://api.github.com"
          PR_NUM="${PR}"
          # use "merge" / "squash" / "rebase" as desired
          resp=$(curl -sSL -X PUT \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API/repos/${REPO}/pulls/${PR_NUM}/merge" \
            -d '{"commit_title":"Merge PR by org-level-automation-app","merge_method":"merge"}')

          merged=$(echo "$resp" | jq -r .merged)
          if [ "$merged" != "true" ]; then
            echo "Merge failed: $resp"
            exit 1
          fi
          echo "PR #${PR_NUM} merged."

      - name: Delete branch
        if: always()
        env:
          TOKEN: ${{ steps.app_token.outputs.token }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ steps.push_branch.outputs.branch }}
        run: |
          set -euo pipefail
          API="https://api.github.com"
          curl -sSL -X DELETE \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API/repos/${REPO}/git/refs/heads/${BRANCH}" || true
          echo "Deleted branch ${BRANCH} (if it existed)."
